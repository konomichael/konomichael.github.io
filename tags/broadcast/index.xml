<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>broadcast on Michael's space</title><link>https://www.michaelchan.space/tags/broadcast/</link><description>Recent content in broadcast on Michael's space</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>Copyright © 2023 author Michael Chan</copyright><lastBuildDate>Mon, 05 Dec 2022 16:19:01 +0800</lastBuildDate><atom:link href="https://www.michaelchan.space/tags/broadcast/index.xml" rel="self" type="application/rss+xml"/><item><title>Understanding Broadcast</title><link>https://www.michaelchan.space/posts/understanding-broadcast/</link><pubDate>Mon, 05 Dec 2022 16:19:01 +0800</pubDate><guid>https://www.michaelchan.space/posts/understanding-broadcast/</guid><description>&lt;p>In the previous post, we discussed how a proposal proposed by a client gets endorsed by other endorsers. When the client has collected enough endorsements for the proposal, it then needs to package these endorsements and send a message to the order service in order to broadcast the transaction wrapped in the proposal. In this post, we will first learn how endorsements are packaged into an &lt;code>Envelope&lt;/code> that can be sent to order service later. Then we will inspect the important role &lt;code>orderer&lt;/code> and figure out how it runs.&lt;/p></description><content>&lt;p>In the previous post, we discussed how a proposal proposed by a client gets endorsed by other endorsers. When the client has collected enough endorsements for the proposal, it then needs to package these endorsements and send a message to the order service in order to broadcast the transaction wrapped in the proposal. In this post, we will first learn how endorsements are packaged into an &lt;code>Envelope&lt;/code> that can be sent to order service later. Then we will inspect the important role &lt;code>orderer&lt;/code> and figure out how it runs.&lt;/p>
&lt;h2 id="create-an-envelope">Create an envelope&lt;/h2>
&lt;p>The &lt;code>Envelope&lt;/code> wraps a payload with a signature so that the message may be authenticated:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Envelope&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// A marshaled Payload
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">Payload&lt;/span> []&lt;span style="color:#66d9ef">byte&lt;/span> &lt;span style="color:#e6db74">`protobuf:&amp;#34;bytes,1,opt,name=payload,proto3&amp;#34; json:&amp;#34;payload,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// A signature by the creator specified in the Payload header
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">Signature&lt;/span> []&lt;span style="color:#66d9ef">byte&lt;/span> &lt;span style="color:#e6db74">`protobuf:&amp;#34;bytes,2,opt,name=signature,proto3&amp;#34; json:&amp;#34;signature,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We must wrap our endorsements, the original proposal, and the signer into the &lt;code>Payload&lt;/code> above. The whole process can be concluded with the following diagram:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">┌───────────┐&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">┌───►&lt;/span>&lt;span style="color:#a6e22e">Signature&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">├──┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌────────────────┐&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└───────────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">├───►&lt;/span> &lt;span style="color:#a6e22e">Envelope&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">┌───────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌───────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#a6e22e">signer&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">├───┴───┤&lt;/span> &lt;span style="color:#a6e22e">Bytes&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">├──┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└────────────────┘&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">└───────────┘&lt;/span> &lt;span style="color:#a6e22e">Sign&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└─────▲─────┘&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">┌─────┴─────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌────────────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌─────────────────┐&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#a6e22e">Payload&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">◄──────┤&lt;/span>&lt;span style="color:#a6e22e">TransactionByte&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">◄───┤&lt;/span> &lt;span style="color:#a6e22e">Transaction&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">└─────▲─────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└────────────────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└────────▲────────┘&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">┌─────┴─────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌───────────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌───────┴─────────┐&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">┌─►&lt;/span> &lt;span style="color:#a6e22e">Header&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">├───────►&lt;/span>&lt;span style="color:#a6e22e">SignatureHeader&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">├────►&lt;/span>&lt;span style="color:#a6e22e">TransactionAction&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└───────────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└───────────────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└───────▲─────────┘&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">┌───────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#a6e22e">proposal&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">├───┤&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌───────┴─────────┐&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">└───────────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#a6e22e">Bytes&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌───────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌──────────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└───────▲─────────┘&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">└─►&lt;/span> &lt;span style="color:#a6e22e">Payload&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">├────────►&lt;/span> &lt;span style="color:#a6e22e">PayloadBytes&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">├─┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">└───────────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└──────────────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌───────┴─────────┐&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">├──►&lt;/span>&lt;span style="color:#a6e22e">ActionPayload&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">┌───────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌──────────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└─────────────────┘&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">┌─►&lt;/span> &lt;span style="color:#a6e22e">Payload&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">├────────►&lt;/span>&lt;span style="color:#a6e22e">EndorsedAction&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">├─┘&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└───────────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└──────▲───────┘&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">┌───────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>&lt;span style="color:#a6e22e">endorsement&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">├───┤&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">└───────────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌───────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">└─►&lt;/span>&lt;span style="color:#a6e22e">Endorsement&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">├───┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">└───────────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌──────┴───────┐&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">├────►&lt;/span> &lt;span style="color:#a6e22e">Endorsements&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌───────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└──────────────┘&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">┌─►&lt;/span>&lt;span style="color:#a6e22e">Endorsement&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">├───┘&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">└───────────┘&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">┌───────────┐&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>&lt;span style="color:#a6e22e">endorsement&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">├───┤&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">└───────────┘&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">┌───────────┐&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">└─►&lt;/span> &lt;span style="color:#a6e22e">Payload&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">│&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">└───────────┘&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Don&amp;rsquo;t get panic about the above diagram. We first extract the &lt;code>Endorsement&lt;/code> and &lt;code>Payload&lt;/code> from all the endorsements the client receives. Of course, we should ensure that all the payloads are the same. Note that the &lt;code>Payload&lt;/code> comprises &lt;code>ProposalHash&lt;/code>, &lt;code>Events&lt;/code>, &lt;code>Results,&lt;/code> and &lt;code>ChaincodeID&lt;/code>, which describe how a proposal is executed on a channel, and the endorsement gives the endorser and signature. With the &lt;code>EndorsedAction&lt;/code>, &lt;code>PayloadBytes&lt;/code> from the original proposal, and the &lt;code>SignatureHeader&lt;/code> extracted from the original proposal&amp;rsquo;s header, we can get the final &lt;code>Transaction&lt;/code>, which will be sent to the order service. Still, before that, we need to do the sign trick again for this &lt;code>Transaction&lt;/code>.&lt;/p>
&lt;h2 id="broadcast">Broadcast&lt;/h2>
&lt;p>The client first calls the function &lt;code>GetBroadcastClientFunc&lt;/code> to get a broadcast client:&lt;/p>
&lt;ol>
&lt;li>Create an instance of an &lt;code>OrderClient&lt;/code> containing &lt;code>orderers' addresses&lt;/code> and &lt;code>clientConfig&lt;/code> from the environment&lt;/li>
&lt;li>Create a gRPC connection object &lt;code>conn&lt;/code> for each of the orderers&amp;rsquo; addresses, with which create an &lt;code>atomicBroadcastClient&lt;/code>&lt;/li>
&lt;li>Invoke the &lt;code>actomicBroadcastClient&lt;/code>&amp;rsquo;s method &lt;code>Broadcast&lt;/code> to build a new stream on the method &lt;code>/orderer.AtomicBroadcast/Broadcast&lt;/code>, yields the final working client &lt;code>atomicBroadcastBroadcastClient&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>A &lt;code>BroadcastOrdererClient&lt;/code> owns multiple such &lt;code>atomicBroadcastBroadcastClient&lt;/code> which guarantees we can send the transaction to multiple &lt;code>orderer&lt;/code>s.&lt;/p>
&lt;p>When a signed transaction is broadcasted to an orderer, the orderer immediately invokes its broadcast handler that was created when the server started to process it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> (&lt;span style="color:#a6e22e">bh&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">Handler&lt;/span>) &lt;span style="color:#a6e22e">Handle&lt;/span>(&lt;span style="color:#a6e22e">srv&lt;/span> &lt;span style="color:#a6e22e">ab&lt;/span>.&lt;span style="color:#a6e22e">AtomicBroadcast_BroadcastServer&lt;/span>) &lt;span style="color:#66d9ef">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">msg&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">srv&lt;/span>.&lt;span style="color:#a6e22e">Recv&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">resp&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">bh&lt;/span>.&lt;span style="color:#a6e22e">ProcessMessage&lt;/span>(&lt;span style="color:#a6e22e">msg&lt;/span>, &lt;span style="color:#a6e22e">addr&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">srv&lt;/span>.&lt;span style="color:#a6e22e">Send&lt;/span>(&lt;span style="color:#a6e22e">resp&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>To handle the transaction, the handler opens a &lt;code>broadcast loop&lt;/code> since there may be multiple rounds of message passing between the orderer and the client. Here we just focus on the key method &lt;code>ProcessMessage&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> (&lt;span style="color:#a6e22e">bh&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">Handler&lt;/span>) &lt;span style="color:#a6e22e">ProcessMessage&lt;/span>(&lt;span style="color:#a6e22e">msg&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">Envelope&lt;/span>, &lt;span style="color:#a6e22e">addr&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>) (&lt;span style="color:#a6e22e">resp&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">ab&lt;/span>.&lt;span style="color:#a6e22e">BroadcastResponse&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">chdr&lt;/span>, &lt;span style="color:#a6e22e">isConfig&lt;/span>, &lt;span style="color:#a6e22e">processor&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">bh&lt;/span>.&lt;span style="color:#a6e22e">SupportRegistrar&lt;/span>.&lt;span style="color:#a6e22e">BroadcastChannelSupport&lt;/span>(&lt;span style="color:#a6e22e">msg&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> !&lt;span style="color:#a6e22e">isConfig&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">configSeq&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">processor&lt;/span>.&lt;span style="color:#a6e22e">ProcessNormalMsg&lt;/span>(&lt;span style="color:#a6e22e">msg&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">processor&lt;/span>.&lt;span style="color:#a6e22e">WaitReady&lt;/span>(); &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">logger&lt;/span>.&lt;span style="color:#a6e22e">Warningf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;[channel: %s] Rejecting broadcast of message from %s with SERVICE_UNAVAILABLE: rejected by Consenter: %s&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">chdr&lt;/span>.&lt;span style="color:#a6e22e">ChannelId&lt;/span>, &lt;span style="color:#a6e22e">addr&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">ab&lt;/span>.&lt;span style="color:#a6e22e">BroadcastResponse&lt;/span>{&lt;span style="color:#a6e22e">Status&lt;/span>: &lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">Status_SERVICE_UNAVAILABLE&lt;/span>, &lt;span style="color:#a6e22e">Info&lt;/span>: &lt;span style="color:#a6e22e">err&lt;/span>.&lt;span style="color:#a6e22e">Error&lt;/span>()}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">processor&lt;/span>.&lt;span style="color:#a6e22e">Order&lt;/span>(&lt;span style="color:#a6e22e">msg&lt;/span>, &lt;span style="color:#a6e22e">configSeq&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">logger&lt;/span>.&lt;span style="color:#a6e22e">Warningf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;[channel: %s] Rejecting broadcast of normal message from %s with SERVICE_UNAVAILABLE: rejected by Order: %s&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">chdr&lt;/span>.&lt;span style="color:#a6e22e">ChannelId&lt;/span>, &lt;span style="color:#a6e22e">addr&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">ab&lt;/span>.&lt;span style="color:#a6e22e">BroadcastResponse&lt;/span>{&lt;span style="color:#a6e22e">Status&lt;/span>: &lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">Status_SERVICE_UNAVAILABLE&lt;/span>, &lt;span style="color:#a6e22e">Info&lt;/span>: &lt;span style="color:#a6e22e">err&lt;/span>.&lt;span style="color:#a6e22e">Error&lt;/span>()}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> { &lt;span style="color:#75715e">// isConfig
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">config&lt;/span>, &lt;span style="color:#a6e22e">configSeq&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">processor&lt;/span>.&lt;span style="color:#a6e22e">ProcessConfigUpdateMsg&lt;/span>(&lt;span style="color:#a6e22e">msg&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">processor&lt;/span>.&lt;span style="color:#a6e22e">WaitReady&lt;/span>(); &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">logger&lt;/span>.&lt;span style="color:#a6e22e">Warningf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;[channel: %s] Rejecting broadcast of message from %s with SERVICE_UNAVAILABLE: rejected by Consenter: %s&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">chdr&lt;/span>.&lt;span style="color:#a6e22e">ChannelId&lt;/span>, &lt;span style="color:#a6e22e">addr&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">ab&lt;/span>.&lt;span style="color:#a6e22e">BroadcastResponse&lt;/span>{&lt;span style="color:#a6e22e">Status&lt;/span>: &lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">Status_SERVICE_UNAVAILABLE&lt;/span>, &lt;span style="color:#a6e22e">Info&lt;/span>: &lt;span style="color:#a6e22e">err&lt;/span>.&lt;span style="color:#a6e22e">Error&lt;/span>()}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">processor&lt;/span>.&lt;span style="color:#a6e22e">Configure&lt;/span>(&lt;span style="color:#a6e22e">config&lt;/span>, &lt;span style="color:#a6e22e">configSeq&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">logger&lt;/span>.&lt;span style="color:#a6e22e">Warningf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;[channel: %s] Rejecting broadcast of config message from %s with SERVICE_UNAVAILABLE: rejected by Configure: %s&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">chdr&lt;/span>.&lt;span style="color:#a6e22e">ChannelId&lt;/span>, &lt;span style="color:#a6e22e">addr&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">ab&lt;/span>.&lt;span style="color:#a6e22e">BroadcastResponse&lt;/span>{&lt;span style="color:#a6e22e">Status&lt;/span>: &lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">Status_SERVICE_UNAVAILABLE&lt;/span>, &lt;span style="color:#a6e22e">Info&lt;/span>: &lt;span style="color:#a6e22e">err&lt;/span>.&lt;span style="color:#a6e22e">Error&lt;/span>()}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">ab&lt;/span>.&lt;span style="color:#a6e22e">BroadcastResponse&lt;/span>{&lt;span style="color:#a6e22e">Status&lt;/span>: &lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">Status_SUCCESS&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It contains several functions we should care about:&lt;/p>
&lt;ul>
&lt;li>&lt;code>BroadcastChannelSupport&lt;/code> parses the message and gives the &lt;code>ChannelHeader&lt;/code>, &lt;code>ChainSupport&lt;/code> which can deal with a &lt;code>channel&lt;/code> according to the &lt;code>channel&lt;/code>, and &lt;code>IsConfig&lt;/code> which shows whether the message is a config update and the channel resources.&lt;/li>
&lt;li>&lt;code>processor.WaitReady&lt;/code> blocks waiting for the consenter to be ready to accept new messages.&lt;/li>
&lt;li>&lt;code>processor.ProcessNormalMsg&lt;/code> process normal transaction message&lt;/li>
&lt;li>&lt;code>processor.ProcessConfigUpdateMsg&lt;/code> process config transaction message&lt;/li>
&lt;li>&lt;code>processor.Order&lt;/code> submits the transaction message consisting of &lt;code>LastValidationSeq&lt;/code>, &lt;code>Payload,&lt;/code> and &lt;code>ChannelID&lt;/code> for ordering. The message goes to the local run goroutine if the current orderer is a leader, otherwise forwarded to the actual leader via RPC. This method finally invokes &lt;code>Chain.Submit&lt;/code> .&lt;/li>
&lt;li>&lt;code>processor.Configure&lt;/code> submits the config transaction message for ordering, which works exactly the same way with &lt;code>processor.Order&lt;/code>.&lt;/li>
&lt;/ul>
&lt;p>Now, let&amp;rsquo;s take a closer look at the &lt;code>ProcessNormalMsg&lt;/code>, &lt;code>ProcessConfigUpdateMsg,&lt;/code> and &lt;code>Chain.Submit&lt;/code>.&lt;/p>
&lt;h3 id="processnoramlmsg">ProcessNoramlMsg&lt;/h3>
&lt;p>The &lt;code>ProcessNormalMsg&lt;/code> is declared as a method of &lt;code>StandardChannel&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> (&lt;span style="color:#a6e22e">s&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">StandardChannel&lt;/span>) &lt;span style="color:#a6e22e">ProcessNormalMsg&lt;/span>(&lt;span style="color:#a6e22e">env&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">Envelope&lt;/span>) (&lt;span style="color:#a6e22e">configSeq&lt;/span> &lt;span style="color:#66d9ef">uint64&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#66d9ef">error&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">oc&lt;/span>, &lt;span style="color:#a6e22e">ok&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">support&lt;/span>.&lt;span style="color:#a6e22e">OrdererConfig&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> !&lt;span style="color:#a6e22e">ok&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">logger&lt;/span>.&lt;span style="color:#a6e22e">Panicf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Missing orderer config&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">oc&lt;/span>.&lt;span style="color:#a6e22e">Capabilities&lt;/span>().&lt;span style="color:#a6e22e">ConsensusTypeMigration&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">oc&lt;/span>.&lt;span style="color:#a6e22e">ConsensusState&lt;/span>() &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#a6e22e">orderer&lt;/span>.&lt;span style="color:#a6e22e">ConsensusType_STATE_NORMAL&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#a6e22e">errors&lt;/span>.&lt;span style="color:#a6e22e">WithMessage&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">ErrMaintenanceMode&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;normal transactions are rejected&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">configSeq&lt;/span> = &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">support&lt;/span>.&lt;span style="color:#a6e22e">Sequence&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">filters&lt;/span>.&lt;span style="color:#a6e22e">Apply&lt;/span>(&lt;span style="color:#a6e22e">env&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The first thing it does is to gain the &lt;code>config Sequence&lt;/code>. In a Hyperledger Fabric network, the channel configuration includes information about the members, policies, etc. When a channel configuration is updated, a new configuration is created with a new sequence number that is incremented by one from the previous configuration sequence number. This allows the network to keep track of the latest channel configuration and ensure that all participating peers are on the same page regarding the channel state.&lt;/p>
&lt;p>The Next thing to do is filter the message using the &lt;code>filters.Apply&lt;/code>. To be filtered means the message should obey the filter&amp;rsquo;s rule such as &lt;code>MaxBytesRule&lt;/code>, &lt;code>expirationRejectRule&lt;/code>, &lt;code>EmptyRejectRule&lt;/code>, &lt;code>SigFilter&lt;/code>, etc. The filters are created at the start of the orderer server, with the initialization of a &lt;code>registrar&lt;/code>.&lt;/p>
&lt;h3 id="processconfigupdatemsg">ProcessConfigUpdateMsg&lt;/h3>
&lt;p>The &lt;code>ProcessConfigUpdateMsg&lt;/code> is also declared in the &lt;code>StandardChannel&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> (&lt;span style="color:#a6e22e">s&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">StandardChannel&lt;/span>) &lt;span style="color:#a6e22e">ProcessConfigUpdateMsg&lt;/span>(&lt;span style="color:#a6e22e">env&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">Envelope&lt;/span>) (&lt;span style="color:#a6e22e">config&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">Envelope&lt;/span>, &lt;span style="color:#a6e22e">configSeq&lt;/span> &lt;span style="color:#66d9ef">uint64&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#66d9ef">error&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">seq&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">support&lt;/span>.&lt;span style="color:#a6e22e">Sequence&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">filters&lt;/span>.&lt;span style="color:#a6e22e">Apply&lt;/span>(&lt;span style="color:#a6e22e">env&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span>, &lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#a6e22e">errors&lt;/span>.&lt;span style="color:#a6e22e">WithMessage&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;config update for existing channel did not pass initial checks&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">configEnvelope&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">support&lt;/span>.&lt;span style="color:#a6e22e">ProposeConfigUpdate&lt;/span>(&lt;span style="color:#a6e22e">env&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span>, &lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#a6e22e">errors&lt;/span>.&lt;span style="color:#a6e22e">WithMessagef&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;error applying config update to existing channel &amp;#39;%s&amp;#39;&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">support&lt;/span>.&lt;span style="color:#a6e22e">ChannelID&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">config&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">protoutil&lt;/span>.&lt;span style="color:#a6e22e">CreateSignedEnvelope&lt;/span>(&lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">HeaderType_CONFIG&lt;/span>, &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">support&lt;/span>.&lt;span style="color:#a6e22e">ChannelID&lt;/span>(), &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">support&lt;/span>.&lt;span style="color:#a6e22e">Signer&lt;/span>(), &lt;span style="color:#a6e22e">configEnvelope&lt;/span>, &lt;span style="color:#a6e22e">msgVersion&lt;/span>, &lt;span style="color:#a6e22e">epoch&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span>, &lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">filters&lt;/span>.&lt;span style="color:#a6e22e">Apply&lt;/span>(&lt;span style="color:#a6e22e">config&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span>, &lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#a6e22e">errors&lt;/span>.&lt;span style="color:#a6e22e">WithMessage&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;config update for existing channel did not pass final checks&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">s&lt;/span>.&lt;span style="color:#a6e22e">maintenanceFilter&lt;/span>.&lt;span style="color:#a6e22e">Apply&lt;/span>(&lt;span style="color:#a6e22e">config&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span>, &lt;span style="color:#ae81ff">0&lt;/span>, &lt;span style="color:#a6e22e">errors&lt;/span>.&lt;span style="color:#a6e22e">WithMessage&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;config update for existing channel did not pass maintenance checks&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">config&lt;/span>, &lt;span style="color:#a6e22e">seq&lt;/span>, &lt;span style="color:#66d9ef">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It first gets the sequence and filters the message just like &lt;code>ProcessNormalMsg&lt;/code>, then it takes in the envelope of the &lt;code>CONFIG_UPDATE&lt;/code> and produces a &lt;code>ConfigEnvelope&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">ConfigEnvelope&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Config&lt;/span>: &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">Config&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Sequence&lt;/span>: &lt;span style="color:#a6e22e">vi&lt;/span>.&lt;span style="color:#a6e22e">sequence&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">ChannelGroup&lt;/span>: &lt;span style="color:#a6e22e">channelGroup&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">LastUpdate&lt;/span>: &lt;span style="color:#a6e22e">configtx&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}, &lt;span style="color:#66d9ef">nil&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>configtx&lt;/code> above is the &lt;code>env&lt;/code> we passed to &lt;code>s.support.ProposeConfigUpdate&lt;/code>. This new envelope is later wrapped in the &lt;code>HeaderType_CONFIG&lt;/code> and signed to orderer.&lt;/p>
&lt;h3 id="submit">Submit&lt;/h3>
&lt;p>The &lt;code>Submit&lt;/code> is a method of &lt;code>Chain&lt;/code>, which defines a way to inject messages for ordering, however, it is not the &lt;code>blockchain&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> (&lt;span style="color:#a6e22e">c&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">Chain&lt;/span>) &lt;span style="color:#a6e22e">Submit&lt;/span>(&lt;span style="color:#a6e22e">req&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">orderer&lt;/span>.&lt;span style="color:#a6e22e">SubmitRequest&lt;/span>, &lt;span style="color:#a6e22e">sender&lt;/span> &lt;span style="color:#66d9ef">uint64&lt;/span>) &lt;span style="color:#66d9ef">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">leadC&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> make(&lt;span style="color:#66d9ef">chan&lt;/span> &lt;span style="color:#66d9ef">uint64&lt;/span>, &lt;span style="color:#ae81ff">1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">select&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">submitC&lt;/span> &lt;span style="color:#f92672">&amp;lt;-&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">submit&lt;/span>{&lt;span style="color:#a6e22e">req&lt;/span>, &lt;span style="color:#a6e22e">leadC&lt;/span>}:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">lead&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#f92672">&amp;lt;-&lt;/span>&lt;span style="color:#a6e22e">leadC&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">lead&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#a6e22e">raft&lt;/span>.&lt;span style="color:#a6e22e">None&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">Metrics&lt;/span>.&lt;span style="color:#a6e22e">ProposalFailures&lt;/span>.&lt;span style="color:#a6e22e">Add&lt;/span>(&lt;span style="color:#ae81ff">1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">errors&lt;/span>.&lt;span style="color:#a6e22e">Errorf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;no Raft leader&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">lead&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">raftID&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">c&lt;/span>.&lt;span style="color:#a6e22e">forwardToLeader&lt;/span>(&lt;span style="color:#a6e22e">lead&lt;/span>, &lt;span style="color:#a6e22e">req&lt;/span>); &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It sends the request to go channel &lt;code>submitC&lt;/code> and receives the current leader in the raft network.&lt;/p>
&lt;ul>
&lt;li>When &lt;code>lead==raft.None&lt;/code>, the leader is not elected yet, and the consensus service is unavailable.&lt;/li>
&lt;li>When &lt;code>lead!=c.raftID&lt;/code>, the current orderer is not the leader, so it just forwards the message to the leader instead of processing it.&lt;/li>
&lt;li>When &lt;code>lead==c.raftID&lt;/code>, the current orderer can process the message, which we will discuss in the next post.&lt;/li>
&lt;/ul>
&lt;h2 id="summary">Summary&lt;/h2>
&lt;p>In this post, we explored how the client wraps the endorsements to request then sends it to the orderer, and the orderer validates the message and then processes or forwards it. Still, we haven&amp;rsquo;t stepped into the core domain of the orderer. Be patient, we will talk about it in the next post.&lt;/p></content></item></channel></rss>