<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>peer on Michael's space</title><link>https://www.michaelchan.space/tags/peer/</link><description>Recent content in peer on Michael's space</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>Copyright Â© 2023 author Michael Chan</copyright><lastBuildDate>Sat, 05 Nov 2022 19:09:20 +0800</lastBuildDate><atom:link href="https://www.michaelchan.space/tags/peer/index.xml" rel="self" type="application/rss+xml"/><item><title>Understanding the Start Process of Hyperledger Peer</title><link>https://www.michaelchan.space/posts/understanding-the-start-process-of-hyperledger-peer/</link><pubDate>Sat, 05 Nov 2022 19:09:20 +0800</pubDate><guid>https://www.michaelchan.space/posts/understanding-the-start-process-of-hyperledger-peer/</guid><description>&lt;p>In the last post, we explored the start process of the chaincode side container, which is simple: starting a gRPC stream and handling the message. However, the peer node&amp;rsquo;s start process is somehow complicated, which involves more components and data structures.&lt;/p></description><content>&lt;p>In the last post, we explored the start process of the chaincode side container, which is simple: starting a gRPC stream and handling the message. However, the peer node&amp;rsquo;s start process is somehow complicated, which involves more components and data structures.&lt;/p>
&lt;h2 id="launch-a-peer-node">Launch a peer node&lt;/h2>
&lt;p>It&amp;rsquo;s easy to launch a peer node using the command: &lt;code>peer node start&lt;/code>, which will finally invoke the function &lt;code>serve&lt;/code>. The &lt;code>serve&lt;/code> function, however, is not well readable and contains lots of start processes of different servers and data structures:&lt;/p>
&lt;ul>
&lt;li>System Server&lt;/li>
&lt;li>LedgerMgr&lt;/li>
&lt;li>gRPC Server&lt;/li>
&lt;li>Gossip Server&lt;/li>
&lt;li>Chaincode Support Server&lt;/li>
&lt;li>Deliver Server&lt;/li>
&lt;li>Chaincode Custodian Server&lt;/li>
&lt;li>Snapshot Server&lt;/li>
&lt;li>Gateway Server&lt;/li>
&lt;/ul>
&lt;h2 id="system-server">System Server&lt;/h2>
&lt;p>The &lt;code>System Server&lt;/code> is a simple HTTP server, initialized in the &lt;code>serve&lt;/code> function:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">opsSystem&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">newOperationsSystem&lt;/span>(&lt;span style="color:#a6e22e">coreConfig&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">err&lt;/span> = &lt;span style="color:#a6e22e">opsSystem&lt;/span>.&lt;span style="color:#a6e22e">Start&lt;/span>()
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As the function name &lt;code>newOperationsSystem&lt;/code> indicates, the &lt;code>System server&lt;/code> works as a system monitor, which provides&lt;/p>
&lt;ul>
&lt;li>Health Check Handler, which is used to check the health status of the peer node.&lt;/li>
&lt;li>Logging Spec Handler, which is used to change the log level of the peer node.&lt;/li>
&lt;li>Metrics Provider, can be implemented by different providers, such as &lt;code>Prometheus&lt;/code> and &lt;code>StatsD&lt;/code>, via which we can get lots of metrics of the peer node.&lt;/li>
&lt;li>Version Info Handler, which is used to get the version information of the peer node.&lt;/li>
&lt;/ul>
&lt;h2 id="ledgermgr">LedgerMgr&lt;/h2>
&lt;p>A &lt;code>LedgerMgr&lt;/code> is a data structure that manages the lifecycle of the ledger, it&amp;rsquo;s data structure is defined as follows:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">LedgerMgr&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">creationLock&lt;/span> &lt;span style="color:#a6e22e">sync&lt;/span>.&lt;span style="color:#a6e22e">Mutex&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">joinBySnapshotStatus&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">pb&lt;/span>.&lt;span style="color:#a6e22e">JoinBySnapshotStatus&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">lock&lt;/span> &lt;span style="color:#a6e22e">sync&lt;/span>.&lt;span style="color:#a6e22e">Mutex&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">openedLedgers&lt;/span> &lt;span style="color:#66d9ef">map&lt;/span>[&lt;span style="color:#66d9ef">string&lt;/span>]&lt;span style="color:#a6e22e">ledger&lt;/span>.&lt;span style="color:#a6e22e">PeerLedger&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">ledgerProvider&lt;/span> &lt;span style="color:#a6e22e">ledger&lt;/span>.&lt;span style="color:#a6e22e">PeerLedgerProvider&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">ebMetadataProvider&lt;/span> &lt;span style="color:#a6e22e">MetadataProvider&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In the &lt;code>serve&lt;/code> function, the &lt;code>LedgerMgr&lt;/code> is initialized as follows:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">peerInstance&lt;/span>.&lt;span style="color:#a6e22e">LedgerMgr&lt;/span> = &lt;span style="color:#a6e22e">ledgermgmt&lt;/span>.&lt;span style="color:#a6e22e">NewLedgerMgr&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">ledgermgmt&lt;/span>.&lt;span style="color:#a6e22e">Initializer&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Here, we pass an &lt;code>initializer&lt;/code> to the &lt;code>NewLedgerMgr&lt;/code> function, which will invoke &lt;code>kv.NewProvider&lt;/code> to take a series of initialization steps:&lt;/p>
&lt;ul>
&lt;li>initialize ledger ID Store to create a database for ledger IDs&lt;/li>
&lt;li>initialize block store to create a database for blocks&lt;/li>
&lt;li>initialize private data store to create a database for private data&lt;/li>
&lt;li>initialize history DB to create a database store for state history&lt;/li>
&lt;li>initialize config history manager to create a database store for config history&lt;/li>
&lt;li>initialize collElgNotifier to listen to the chaincode events&lt;/li>
&lt;li>initialize state listeners which include &lt;code>collElgNotifier&lt;/code> and &lt;code>configHistoryMgr&lt;/code>&lt;/li>
&lt;li>initialize state DB to create a database store for the state&lt;/li>
&lt;li>initialize ledger statistics to statistics the ledger block processing time, the block storage commit time, the state DB commit time and the transaction count&lt;/li>
&lt;li>scans for and deletes any ledger with a status of &lt;code>UNDER_CONSTRUCTION&lt;/code> or &lt;code>UNDER_DELETION&lt;/code>&lt;/li>
&lt;li>initialize snapshot directory to create a directory for the snapshot&lt;/li>
&lt;/ul>
&lt;h2 id="grpc-server">gRPC Server&lt;/h2>
&lt;p>The &lt;code>gRPC Server&lt;/code> here is a common server that can be wrapped by different services, such as &lt;code>DeliverServer&lt;/code>, &lt;code>SnapshotServer&lt;/code>. The &lt;code>gRPC Server&lt;/code> is initialized in the &lt;code>serve&lt;/code> function as follows:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">peerServer&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">comm&lt;/span>.&lt;span style="color:#a6e22e">NewGRPCServer&lt;/span>(&lt;span style="color:#a6e22e">listenAddr&lt;/span>, &lt;span style="color:#a6e22e">serverConfig&lt;/span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The server config contains the options such as &lt;code>MaxRecvMsgSize&lt;/code>, &lt;code>MaxSendMsgSize&lt;/code>, &lt;code>StreamInterceptors&lt;/code>, &lt;code>UnaryInterceptors&lt;/code>, etc.&lt;/p>
&lt;h2 id="gossip-server">Gossip Server&lt;/h2>
&lt;p>The &lt;code>Gossip Server&lt;/code> of a peer node is used to gossip the blocks and transactions to other peer nodes which based on the &lt;code>gossip&lt;/code> protocol. The &lt;code>Gossip Server&lt;/code> is initialized by &lt;code>initGossipService&lt;/code> function, which does the following steps:&lt;/p>
&lt;ul>
&lt;li>determine if TLS is enabled, if so, load and store the server&amp;rsquo;s and client&amp;rsquo;s TLS certificates&lt;/li>
&lt;li>invoke &lt;code>NewMCS&lt;/code> to create a message crypto service, which is used to authenticate the identity of the peer node and verify the signature of the message&lt;/li>
&lt;li>invoke &lt;code>NewSecurityAdvisor&lt;/code> to create a security advisor, which is an external auxiliary object that provides security and identity-related capabilities&lt;/li>
&lt;li>Wrap the &lt;code>gossipService&lt;/code> with &lt;code>gPRC Server&lt;/code> and the other components, such as &lt;code>MCS&lt;/code>, &lt;code>SecurityAdvisor&lt;/code>, etc.&lt;/li>
&lt;/ul>
&lt;h2 id="chaincode-support-server">Chaincode Support Server&lt;/h2>
&lt;p>The &lt;code>Chaincode Support Server&lt;/code> is used to handle chaincode-related requests, such as &lt;code>Install&lt;/code>, &lt;code>Invoke&lt;/code>, &lt;code>Query&lt;/code>, etc.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">ca&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">tlsgen&lt;/span>.&lt;span style="color:#a6e22e">NewCA&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">ccSrv&lt;/span>, &lt;span style="color:#a6e22e">ccEndpoint&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">createChaincodeServer&lt;/span>(&lt;span style="color:#a6e22e">coreConfig&lt;/span>, &lt;span style="color:#a6e22e">ca&lt;/span>, &lt;span style="color:#a6e22e">peerHost&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">chaincodeSupport&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">chaincode&lt;/span>.&lt;span style="color:#a6e22e">ChaincodeSupport&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">ccSupSrv&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">pb&lt;/span>.&lt;span style="color:#a6e22e">ChaincodeSupportServer&lt;/span>(&lt;span style="color:#a6e22e">chaincodeSupport&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">pb&lt;/span>.&lt;span style="color:#a6e22e">RegisterChaincodeSupportServer&lt;/span>(&lt;span style="color:#a6e22e">ccSrv&lt;/span>.&lt;span style="color:#a6e22e">Server&lt;/span>(), &lt;span style="color:#a6e22e">ccSupSrv&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">go&lt;/span> &lt;span style="color:#a6e22e">ccSrv&lt;/span>.&lt;span style="color:#a6e22e">Start&lt;/span>()
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As the above code shows, the &lt;code>ChaincodeSupportServer&lt;/code> starts with the steps:&lt;/p>
&lt;ul>
&lt;li>Invoke &lt;code>NewCA&lt;/code> to create a self-signed CA for chaincode service&lt;/li>
&lt;li>Invoke &lt;code>createChaincodeServer&lt;/code> to create a listener(which is a gRPC server created with &lt;code>comm.NewGRPCServer&lt;/code>) using &lt;code>peer.chaincodeListneAddress&lt;/code>&lt;/li>
&lt;li>cast the &lt;code>chaincodeSupport&lt;/code> to &lt;code>pb.ChiancodeSupportServer&lt;/code> interface which must own the method (or API) &lt;code>Register(ChaincodeSupport_RegisterServer) error&lt;/code>&lt;/li>
&lt;li>Register the casted server API(&lt;code>ccSupSrv&lt;/code>) to the gRPC server(&lt;code>ccSrv.Server()&lt;/code>)&lt;/li>
&lt;li>Start gRPC server&lt;/li>
&lt;/ul>
&lt;h2 id="deliver-server">Deliver Server&lt;/h2>
&lt;p>The &lt;code>Deliver server&lt;/code> is primarily used for the delivery and filter of the blocks:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">DeliverServer&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Deliver&lt;/span>(&lt;span style="color:#a6e22e">Deliver_DeliverServer&lt;/span>) &lt;span style="color:#66d9ef">error&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">DeliverFiltered&lt;/span>(&lt;span style="color:#a6e22e">Deliver_DeliverFilteredServer&lt;/span>) &lt;span style="color:#66d9ef">error&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">DeliverWithPrivateData&lt;/span>(&lt;span style="color:#a6e22e">Deliver_DeliverWithPrivateDataServer&lt;/span>) &lt;span style="color:#66d9ef">error&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As same as the &lt;code>Chaincode support Server&lt;/code>, we first create the instance of &lt;code>Deliver Server&lt;/code>, then register it to the gRPC server (the peer server, as mentioned above):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">mutualTLS&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">serverConfig&lt;/span>.&lt;span style="color:#a6e22e">SecOpts&lt;/span>.&lt;span style="color:#a6e22e">UseTLS&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#a6e22e">serverConfig&lt;/span>.&lt;span style="color:#a6e22e">SecOpts&lt;/span>.&lt;span style="color:#a6e22e">RequireClientCert&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">policyCheckerProvider&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#66d9ef">func&lt;/span>(&lt;span style="color:#a6e22e">resourceName&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>) &lt;span style="color:#a6e22e">deliver&lt;/span>.&lt;span style="color:#a6e22e">PolicyCheckerFunc&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">func&lt;/span>(&lt;span style="color:#a6e22e">env&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">cb&lt;/span>.&lt;span style="color:#a6e22e">Envelope&lt;/span>, &lt;span style="color:#a6e22e">channelID&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>) &lt;span style="color:#66d9ef">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">aclProvider&lt;/span>.&lt;span style="color:#a6e22e">CheckACL&lt;/span>(&lt;span style="color:#a6e22e">resourceName&lt;/span>, &lt;span style="color:#a6e22e">channelID&lt;/span>, &lt;span style="color:#a6e22e">env&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">metrics&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">deliver&lt;/span>.&lt;span style="color:#a6e22e">NewMetrics&lt;/span>(&lt;span style="color:#a6e22e">metricsProvider&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">abServer&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">peer&lt;/span>.&lt;span style="color:#a6e22e">DeliverServer&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">DeliverHandler&lt;/span>: &lt;span style="color:#a6e22e">deliver&lt;/span>.&lt;span style="color:#a6e22e">NewHandler&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">peer&lt;/span>.&lt;span style="color:#a6e22e">DeliverChainManager&lt;/span>{&lt;span style="color:#a6e22e">Peer&lt;/span>: &lt;span style="color:#a6e22e">peerInstance&lt;/span>},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">coreConfig&lt;/span>.&lt;span style="color:#a6e22e">AuthenticationTimeWindow&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">mutualTLS&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">metrics&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">false&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">PolicyCheckerProvider&lt;/span>: &lt;span style="color:#a6e22e">policyCheckerProvider&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">pb&lt;/span>.&lt;span style="color:#a6e22e">RegisterDeliverServer&lt;/span>(&lt;span style="color:#a6e22e">peerServer&lt;/span>.&lt;span style="color:#a6e22e">Server&lt;/span>(), &lt;span style="color:#a6e22e">abServer&lt;/span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The steps are shown from the above:&lt;/p>
&lt;ul>
&lt;li>Acquire the resource check &lt;code>policyCheckerProvider&lt;/code>, which invokes &lt;code>CheckACL&lt;/code> to check ACL (Access Control Lists) for the given channel(&lt;code>channelID&lt;/code>) using the &lt;code>env(the 1st parameter)&lt;/code>. As for the resources to be checked, the deliver focuses on the &lt;code>Event_FilteredBlock&lt;/code> and &lt;code>Event_Block&lt;/code>&lt;/li>
&lt;li>Create a handler to handle the events, which will parse the event, check the ACL, then delivery the blocks.&lt;/li>
&lt;li>Register the &lt;code>abServer&lt;/code> to the gRPC server.&lt;/li>
&lt;/ul>
&lt;h2 id="deploy-system-chaincode">Deploy System Chaincode&lt;/h2>
&lt;blockquote>
&lt;p>The System chaincodes are specialized chaincodes that run as part of the peer process as opposed to user chaincodes that run in separate docker containers. Examples of System Chaincodes include QSCC (Query System Chaincode) for ledger and other Fabric-related queries, CSCC (Configuration System Chaincode) which helps regulate access control, and LSCC (Lifecycle System Chaincode). Unlike a user chaincode, a system chaincode is not installed and instantiated using proposals from SDKs or CLI. It is registered and deployed by the peer at start-up.&lt;/p>
&lt;p>&lt;a href="https://hyperledger-fabric.readthedocs.io/en/release-1.3/systemchaincode.html">https://hyperledger-fabric.readthedocs.io/en/release-1.3/systemchaincode.html&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>The following code shows how the system chaincodes are deployed:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// deploy system chaincodes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#a6e22e">_&lt;/span>, &lt;span style="color:#a6e22e">cc&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#66d9ef">range&lt;/span> []&lt;span style="color:#a6e22e">scc&lt;/span>.&lt;span style="color:#a6e22e">SelfDescribingSysCC&lt;/span>{&lt;span style="color:#a6e22e">lsccInst&lt;/span>, &lt;span style="color:#a6e22e">csccInst&lt;/span>, &lt;span style="color:#a6e22e">qsccInst&lt;/span>, &lt;span style="color:#a6e22e">lifecycleSCC&lt;/span>} {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">enabled&lt;/span>, &lt;span style="color:#a6e22e">ok&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">chaincodeConfig&lt;/span>.&lt;span style="color:#a6e22e">SCCAllowlist&lt;/span>[&lt;span style="color:#a6e22e">cc&lt;/span>.&lt;span style="color:#a6e22e">Name&lt;/span>()]; !&lt;span style="color:#a6e22e">ok&lt;/span> &lt;span style="color:#f92672">||&lt;/span> !&lt;span style="color:#a6e22e">enabled&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">logger&lt;/span>.&lt;span style="color:#a6e22e">Infof&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;not deploying chaincode %s as it is not enabled&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">cc&lt;/span>.&lt;span style="color:#a6e22e">Name&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">scc&lt;/span>.&lt;span style="color:#a6e22e">DeploySysCC&lt;/span>(&lt;span style="color:#a6e22e">cc&lt;/span>, &lt;span style="color:#a6e22e">chaincodeSupport&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The function &lt;code>DeploySysCC&lt;/code> is finally invoked, in which the chaincode starts as we talked about &lt;a href="posts/understanding-the-start-process-of-hyperledger-chaincode/">before&lt;/a>. The difference is &lt;code>shim.StartInProc&lt;/code> is invoked instead of &lt;code>shim.Start&lt;/code>.&lt;/p>
&lt;h2 id="chaincode-custodian-server">Chaincode Custodian Server&lt;/h2>
&lt;p>The &lt;code>Chaincode Custodian&lt;/code> is responsible for enqueuing builds and launches of chaincodes as they become available and stops when chaincodes are no longer referenced by an active chaincode definition.&lt;/p>
&lt;p>The custodian follows the &lt;code>Producer-Consumer&lt;/code> pattern, where the requests to manage the chaincode lifecycle are added to a queue (by the Producer), and the Consumer (Custodian) retrieves and processes them.&lt;/p>
&lt;h2 id="snapshot-server">Snapshot Server&lt;/h2>
&lt;p>The &lt;code>Snapshot&lt;/code> is introduced in &lt;code>Fabric v2.3&lt;/code>, which gives us an alternative way to join new peers into a fabric network. The details can be found &lt;a href="https://hyperledger-fabric.readthedocs.io/en/latest/peer_ledger_snapshot.html">here&lt;/a>. Just like the &lt;code>Deliver&lt;/code>, we just need to create a snapshot server instance, and attach it to the peer gRPC server:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">snapshotSvc&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">snapshotgrpc&lt;/span>.&lt;span style="color:#a6e22e">SnapshotService&lt;/span>{&lt;span style="color:#a6e22e">LedgerGetter&lt;/span>: &lt;span style="color:#a6e22e">peerInstance&lt;/span>, &lt;span style="color:#a6e22e">ACLProvider&lt;/span>: &lt;span style="color:#a6e22e">aclProvider&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">pb&lt;/span>.&lt;span style="color:#a6e22e">RegisterSnapshotServer&lt;/span>(&lt;span style="color:#a6e22e">peerServer&lt;/span>.&lt;span style="color:#a6e22e">Server&lt;/span>(), &lt;span style="color:#a6e22e">snapshotSvc&lt;/span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="gateway-server">Gateway Server&lt;/h2>
&lt;p>The &lt;code>Gateway&lt;/code> is introduced in &lt;code>Fabric v2.4&lt;/code>, which provides a simplified, minimal API for submitting transactions to a Fabric network:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">GatewayServer&lt;/span> &lt;span style="color:#66d9ef">interface&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Endorse&lt;/span>(&lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>, &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">EndorseRequest&lt;/span>) (&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">EndorseResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Submit&lt;/span>(&lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>, &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">SubmitRequest&lt;/span>) (&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">SubmitResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">CommitStatus&lt;/span>(&lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>, &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">SignedCommitStatusRequest&lt;/span>) (&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">CommitStatusResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Evaluate&lt;/span>(&lt;span style="color:#a6e22e">context&lt;/span>.&lt;span style="color:#a6e22e">Context&lt;/span>, &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">EvaluateRequest&lt;/span>) (&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">EvaluateResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">ChaincodeEvents&lt;/span>(&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">SignedChaincodeEventsRequest&lt;/span>, &lt;span style="color:#a6e22e">Gateway_ChaincodeEventsServer&lt;/span>) &lt;span style="color:#66d9ef">error&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The details can be found &lt;a href="https://hyperledger-fabric.readthedocs.io/en/latest/gateway.html">here&lt;/a>. Also, the gateway server is registered to the peer gRPC server in the same way same as the snapshot and deliver.&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>In conclusion, launching a Hyperledger Fabric peer node involves initializing multiple servers and data structures such as the System Server, LedgerMgr, gRPC Server, Gossip Server, Chaincode Support Server, Deliver Server, Chaincode Custodian Server, Snapshot Server, Gateway Server, etc. While this post provides a high-level overview of these components, much more detail is required to truly understand how they work together to form a robust and secure blockchain network. In future discussions, we will delve deeper into each of these elements and explore their functions and interactions.&lt;/p></content></item></channel></rss>